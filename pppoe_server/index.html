<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MikroTik ISP Generator (v7 - Full Interfaces)</title>
    <style>
        :root { --primary: #0f172a; --accent: #3b82f6; --bg: #f1f5f9; --panel: #ffffff; --border: #cbd5e1; --success: #10b981; }
        
        /* Reset body to allow full-width navbar */
        body { margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: #334155; line-height: 1.5; }
        
        /* Navbar Styles */
        .navbar-dark { background-color: var(--primary); padding: 15px 40px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 30px; }
        .nav-brand { color: white; font-size: 1.25rem; font-weight: bold; letter-spacing: 0.5px; }
        .nav-links a { color: #cbd5e1; text-decoration: none; margin-left: 25px; font-weight: 500; font-size: 0.95rem; transition: color 0.2s ease; }
        .nav-links a:hover, .nav-links a.active { color: var(--accent); }

        /* Layout */
        .container { max-width: 1400px; margin: 0 auto; padding: 0 20px 20px 20px; }
        h1 { color: var(--primary); margin-bottom: 20px; border-bottom: 3px solid var(--accent); display: inline-block; padding-bottom: 5px; margin-top: 0;}
        h2 { font-size: 1.1rem; margin-top: 0; color: var(--accent); border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 15px;}
        
        .grid { display: grid; grid-template-columns: 320px 1fr; gap: 20px; }
        @media (max-width: 1000px) { .grid { grid-template-columns: 1fr; } }
        
        /* Cards */
        .card { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* Inputs */
        label { display: block; font-weight: 600; font-size: 0.85rem; margin-bottom: 4px; color: #64748b; }
        input[type="text"], input[type="number"] { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; margin-bottom: 12px; font-family: monospace; font-size: 0.9rem; box-sizing: border-box; }
        input:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }

        /* Output */
        textarea { width: 100%; height: 700px; background: #1e293b; color: #e2e8f0; font-family: 'Consolas', monospace; font-size: 13px; padding: 15px; border-radius: 6px; border: none; resize: vertical; white-space: pre; overflow-wrap: normal; overflow-x: scroll;}
        
        /* Buttons */
        button.btn-gen { background: var(--accent); color: white; border: none; padding: 15px; border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%; font-size: 1rem; transition: transform 0.1s; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5); }
        button.btn-gen:hover { background: #2563eb; transform: translateY(-1px); }
        button.btn-gen:active { transform: translateY(1px); }

        button.btn-copy { background: var(--success); color: white; border: none; padding: 6px 12px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 0.85rem; transition: background 0.2s; }
        button.btn-copy:hover { background: #059669; }

        /* Package Grid */
        .pkg-grid { display: grid; grid-template-columns: 35px 2fr 1fr 1fr 1fr; gap: 8px; align-items: center; margin-bottom: 5px; font-size: 0.85rem; }
        .pkg-header { font-weight: bold; background: #f8fafc; padding: 8px; border-bottom: 2px solid var(--border); }
        .interface-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        .header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 8px;}
        .header-flex h2 { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
    </style>
</head>
<body>

<nav class="navbar-dark">
    <div class="nav-brand">üåê ISP Admin</div>
    <div class="nav-links">
        <a href="/pppoe_server">Home</a>
        <a href="index.html" class="active">V1_Package</a>
        <a href="index_v2.html">V2_Package</a>
        <a href="#">Settings</a>
    </div>
</nav>

<div class="container">
    <h1>MikroTik v7 Generator (Multi-Interface)</h1>
    
    <div class="grid">
        <div class="sidebar">
            
            <div class="card">
                <h2>üåê Network Setup</h2>
                <label>Starting Pool Network</label>
                <input type="text" id="startIP" value="172.20.0.0">
                <div style="font-size: 0.75rem; color: #94a3b8; margin-top: -8px; margin-bottom: 10px;">Autogenerates 10 subnets (/20)</div>

                <label>DNS Servers</label>
                <input type="text" id="dns" value="8.8.8.8,1.1.1.1">
            </div>

            <div class="card">
                <h2>üîå Interface Names</h2>
                <div class="interface-group">
                    <div>
                        <label>BDIX Interface</label>
                        <input type="text" id="intBDIX" value="1.1-2641-BDIX">
                    </div>
                    <div>
                        <label>GGC Interface</label>
                        <input type="text" id="intGGC" value="1.3-2643-GGC">
                    </div>
                    <div>
                        <label>Facebook Interface</label>
                        <input type="text" id="intFB" value="1.4-2644-FB">
                    </div>
                    <div>
                        <label>CDN Interface</label>
                        <input type="text" id="intCDN" value="1.5-2645-CDN">
                    </div>
                    <div>
                        <label>FTP Interface</label>
                        <input type="text" id="intFTP" value="1.7-2647-FTP">
                    </div>
                    <div>
                        <label>TikTok Interface</label>
                        <input type="text" id="intTIK" value="1.8-2648-TIK">
                    </div>
                </div>
            </div>

            <button class="btn-gen" onclick="generateScript()">‚ö° Generate Full Script</button>
        </div>

        <div class="main-content">
            
            <div class="card">
                <h2>üì¶ Packages (P1 - P10)</h2>
                <div class="pkg-grid pkg-header">
                    <div>#</div>
                    <div>Pkg Name</div>
                    <div>Rate (M)</div>
                    <div>Price</div>
                    <div>Boost (M)</div>
                </div>
                <div id="packagesContainerP"></div>
            </div>

            <div class="card">
                <div class="header-flex">
                    <h2>üìú Script Output</h2>
                    <button class="btn-copy" onclick="copyConfig()" id="copyBtn">üìã Copy Script</button>
                </div>
                <textarea id="output" readonly onclick="this.select()">Click "Generate Full Script" to create the code...</textarea>
            </div>
        </div>
    </div>
</div>

<script>
    // Default Data for P1 - P10
    const defaultsP = [
        { name: "Bronze", rate: 20, price: 500, boost: 30 },
        { name: "Silver", rate: 25, price: 600, boost: 40 },
        { name: "Gold", rate: 35, price: 700, boost: 50 },
        { name: "Platinum", rate: 45, price: 800, boost: 60 },
        { name: "Diamond", rate: 55, price: 1000, boost: 70 },
        { name: "Sapphire", rate: 65, price: 1200, boost: 80 },
        { name: "Ruby", rate: 75, price: 1400, boost: 90 },
        { name: "Emerald", rate: 85, price: 1600, boost: 90 },
        { name: "Pearl", rate: 95, price: 1800, boost: 100 },
        { name: "Onyx", rate: 100, price: 2000, boost: 100 }
    ];

    // Build Package Rows Utility
    function buildGrid(containerId, defaults, prefix) {
        const container = document.getElementById(containerId);
        defaults.forEach((pkg, index) => {
            const i = index + 1;
            container.innerHTML += `
                <div class="pkg-grid">
                    <div style="font-weight:bold; color:#cbd5e1;">${prefix}${i}</div>
                    <input type="text" id="name_${prefix}${i}" value="${pkg.name}">
                    <input type="number" id="rate_${prefix}${i}" value="${pkg.rate}">
                    <input type="number" id="price_${prefix}${i}" value="${pkg.price}">
                    <input type="number" id="boost_${prefix}${i}" value="${pkg.boost}">
                </div>
            `;
        });
    }

    // Initialize grid
    buildGrid('packagesContainerP', defaultsP, 'P');

    // IPv4 Math Utilities (prevents octet overflow errors)
    function ipToInt(ip) {
        return ip.split('.').reduce((acc, octet) => (acc << 8) + parseInt(octet, 10), 0) >>> 0;
    }
    function intToIp(int) {
        return [ (int >>> 24) & 255, (int >>> 16) & 255, (int >>> 8) & 255, int & 255 ].join('.');
    }

    function calculateSubnets(startIP) {
        let parts = startIP.split('.');
        if (parts.length !== 4) return null;
        
        let startInt = ipToInt(startIP);
        let subnets = [];
        
        // Define sequence: P1-P10
        const pkgKeys = [];
        for(let i=1; i<=10; i++) pkgKeys.push({ prefix: 'P', num: i });

        for (let i = 0; i < 10; i++) {
            let key = pkgKeys[i];
            
            // A /20 contains 4096 IP addresses
            let netInt = startInt + (i * 4096); 
            let gatewayInt = netInt + 1;
            let rangeStartInt = netInt + 2;
            let rangeEndInt = netInt + 4094; // .254 of the last /24 in the block

            let netIp = intToIp(netInt);
            let gatewayIp = intToIp(gatewayInt);
            let rangeIp = `${intToIp(rangeStartInt)}-${intToIp(rangeEndInt)}`;

            let nameField = document.getElementById(`name_${key.prefix}${key.num}`).value;
            let poolName = `pool_${key.prefix}${key.num}_${nameField.toLowerCase().replace(/\s/g,'_')}`;

            subnets.push({
                cidr: `${netIp}/20`,
                gateway: gatewayIp,
                range: rangeIp,
                poolName: poolName,
                prefix: key.prefix,
                num: key.num,
                name: nameField,
                rate: document.getElementById(`rate_${key.prefix}${key.num}`).value,
                price: document.getElementById(`price_${key.prefix}${key.num}`).value,
                boost: document.getElementById(`boost_${key.prefix}${key.num}`).value
            });
        }
        return subnets;
    }

    function generateScript() {
        const startIP = document.getElementById('startIP').value.trim();
        const dns = document.getElementById('dns').value.trim();
        
        // Interfaces
        const interfaces = [
            { id: 'intBDIX', prefix: 'BDIX' },
            { id: 'intGGC',  prefix: 'GGC' },
            { id: 'intFB',   prefix: 'FNA' },
            { id: 'intCDN',  prefix: 'CDN' },
            { id: 'intFTP',  prefix: 'FTP' },
            { id: 'intTIK',  prefix: 'TIK' }
        ];

        const subnets = calculateSubnets(startIP);
        if (!subnets) { alert("Check Starting IP format"); return; }

        let s = `# ===================================================================\n`;
        s += `# MIKROTIK v7 GENERATOR - ${new Date().toLocaleString()}\n`;
        s += `# ===================================================================\n\n`;

        // 1. POOLS
        s += `# --- 1. IP POOLS ---\n/ip pool\n`;
        subnets.forEach(net => s += `add name="${net.poolName}" ranges=${net.range}\n`);
        s += `\n`;

        // 2. LOGGING
        s += `# --- 2. LOGGING ---\n`;
        s += `:global pppOnUp ":local remoteAddr \\$\\"remote-address\\"; :local callerId \\$\\"caller-id\\"; :local sessId [/ppp active get [find name=\\$user] session-id]; :log info \\"PPPLOG \\$user \\$callerId \\$remoteAddr \\$sessId\\""\n\n`;

        // 3. PROFILES
        s += `# --- 3. PPP PROFILES ---\n/ppp profile\n`;
        subnets.forEach(net => {
            s += `add name="${net.prefix}${net.num}_${net.name}_${net.rate}Mbps" local-address=${net.gateway} remote-address="${net.poolName}" \\\n`;
            s += `    only-one=yes on-up=$pppOnUp dns-server=${dns} rate-limit=${net.rate}M/${net.rate}M comment="Price: ${net.price} Tk - ${net.rate} Mbps"\n\n`;
        });

        // 4. FIREWALL (Using /16 to perfectly cover 10 consecutive /20 networks safely)
        let fwBaseIP = intToIp(ipToInt(startIP)); // Clean formatted base IP
        s += `# --- 4. FIREWALL ---\n/ip firewall nat\n`;
        s += `add chain=srcnat action=masquerade src-address=${fwBaseIP}/16 comment="NAT for All Packages"\n\n`;
        s += `/ip firewall mangle\n`;
        s += `add chain=forward action=add-src-to-address-list address-list=2_RT_BLOCK address-list-timeout=30s src-address=${fwBaseIP}/16 in-interface=all-ppp connection-state=established ttl=1-61 comment="Detect Shared Connection"\n\n`;
        s += `/ip firewall raw\n`;
        s += `add chain=prerouting action=drop src-address-list=2_RT_BLOCK ttl=1-62 comment="Drop Shared Connection"\n\n`;

        // 5. QUEUE TYPES
        s += `# --- 5. QUEUE TYPES (PCQ) ---\n/queue type\n`;
        let rates = new Set();
        subnets.forEach(net => {
            rates.add(parseInt(net.rate));
            rates.add(parseInt(net.boost));
        });
        let sortedRates = Array.from(rates).sort((a,b)=>a-b);

        // General Types
        sortedRates.forEach(r => {
            s += `add kind=pcq name="pcq_down_${r}M" pcq-rate=${r}M pcq-classifier=dst-address\n`;
            s += `add kind=pcq name="pcq_up_${r}M" pcq-rate=${r}M pcq-classifier=src-address\n`;
        });
        
        // Unified Boost Types
        sortedRates.forEach(r => {
            s += `add kind=pcq name="pcq_boost_down_${r}M" pcq-rate=${r}M pcq-classifier=dst-address\n`;
            s += `add kind=pcq name="pcq_boost_up_${r}M" pcq-rate=${r}M pcq-classifier=src-address\n`;
        });
        s += `\n`;

        // 6. SIMPLE QUEUES (INTERFACES)
        s += `# --- 6. SIMPLE QUEUES (SPEED BOOSTS) ---\n/queue simple\n`;
        interfaces.forEach(iface => {
            const intName = document.getElementById(iface.id).value.trim();
            if(!intName) return;

            s += `# --- ${iface.prefix} (${intName}) ---\n`;
            subnets.forEach((net, index) => {
                let comment = index === 0 ? `--- ${iface.prefix} Queues --- (${net.boost}Mbps)` : `${iface.prefix}: ${net.boost}Mbps`;
                s += `add name="${iface.prefix}_${net.prefix}${net.num}" target=${net.cidr} dst="${intName}" queue=pcq_boost_up_${net.boost}M/pcq_boost_down_${net.boost}M place-before=0 comment="${comment}"\n`;
            });
            s += `\n`;
        });

        // 7. MAIN QUEUES
        s += `# --- 7. MAIN INTERNET QUEUES ---\n`;
        subnets.forEach((net, index) => {
            let queueComment = index === 0 ? `--- Main Internet Queues --- (${net.rate} Mbps)` : `${net.rate} Mbps per user`;
            s += `add name="${net.prefix}${net.num}_${net.name}_Block" target=${net.cidr} queue=pcq_up_${net.rate}M/pcq_down_${net.rate}M comment="${queueComment}"\n`;
        });

        document.getElementById('output').value = s;
    }

    // Copy to Clipboard Function
    function copyConfig() {
        const outputTextarea = document.getElementById('output');
        const copyBtn = document.getElementById('copyBtn');
        
        // Ensure there is something generated to copy
        if (outputTextarea.value.includes('Click "Generate Full Script"')) {
            alert("Please generate the script first!");
            return;
        }

        outputTextarea.select();
        outputTextarea.setSelectionRange(0, 99999); // For mobile devices

        navigator.clipboard.writeText(outputTextarea.value).then(() => {
            // Change button appearance temporarily
            copyBtn.innerText = "‚úÖ Copied!";
            copyBtn.style.background = "#059669";
            
            setTimeout(() => {
                copyBtn.innerText = "üìã Copy Script";
                copyBtn.style.background = "var(--success)";
            }, 2000);
        }).catch(err => {
            console.error("Failed to copy text: ", err);
            alert("Failed to copy. Please select the text and copy manually.");
        });
    }
</script>

</body>
</html>